

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Lecture 3: Disk Management and Indexes &#8212; BAIT 580A - Topics in Information Technology Management</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'lectures/lecture3';</script>
    <link rel="shortcut icon" href="../_static/logo.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Installation instructions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../installation/awssummary.html">Overview first week installations and setup.</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/conda.html">Conda</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/jupyterlabtest.html">JuypterLab</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/aws.html">AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/pgadmin.html">pgAdmin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation/dump.html">Load Dumps (using pgadmin)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Additional materials / Refresher</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../additional/pscopg2.html">Using psycopg2 package</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Video series</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../additional/video.html">Mini Video series</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Lectures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lecture0.html">Lecture 0: Course Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture1.html">Lecture 1: Data Management in a Big Data Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="lecture2.html">Lecture 2: Setting up RDS and connection to cloud</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/ggeorg02/BAIT580/master?urlpath=tree/lectures/lecture3.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="initThebeSBT()"
  class="btn btn-sm btn-launch-thebe dropdown-item"
  title="Launch Thebe"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="btn__text-container">Live Code</span>
</button>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/ggeorg02/BAIT580/edit/master/lectures/lecture3.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/ggeorg02/BAIT580/issues/new?title=Issue%20on%20page%20%2Flectures/lecture3.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/lectures/lecture3.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Lecture 3: Disk Management and Indexes</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#announcements">Announcements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#todays-agenda">Todays Agenda</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-humans-store-and-search-data">How do humans store and search data?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-does-postgres-store-data">How does Postgres store data?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-does-postgres-search-data">How does Postgres search data?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-are-indexes">WHAT are indexes?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#different-kinds-of-indexes">Different kinds of indexes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-tree">B-Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hash">Hash</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gin">GIN</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#trigrams-details-optional">Trigrams Details (OPTIONAL)</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gist">GIST</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#brin">BRIN</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compared-to-other-services-optional">Compared to Other Services (optional)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#class-activity">Class activity</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lecture-3-disk-management-and-indexes">
<h1>Lecture 3: Disk Management and Indexes<a class="headerlink" href="#lecture-3-disk-management-and-indexes" title="Permalink to this headline">#</a></h1>
<p>Gittu George, January 10 2023</p>
<section id="announcements">
<h2>Announcements<a class="headerlink" href="#announcements" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Change in deadlines</p></li>
<li><p>Regrade requests</p></li>
<li><p>Video corner</p></li>
<li><p>Tutorials for students with a very less technical background</p></li>
<li><p>We don’t accept late submissions</p></li>
<li><p>Inclass TA only during the last 1 hour</p></li>
</ul>
</section>
<section id="todays-agenda">
<h2>Todays Agenda<a class="headerlink" href="#todays-agenda" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>HOW do humans store and search data?</p></li>
<li><p>HOW does Postgres store data?</p></li>
<li><p>HOW does Postgres search data?</p></li>
<li><p>WHY indexes?</p></li>
<li><p>WHAT are indexes?</p></li>
<li><p>Different kinds of indexes</p></li>
<li><p>Do I need an index?</p></li>
</ul>
</section>
<section id="learning-objectives">
<h2>Learning objectives<a class="headerlink" href="#learning-objectives" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>You will apply knowledge of disk management and query structure to optimize complex queries.</p></li>
<li><p>You will understand the different types of INDEXes available in Postgres and the best-suited applications</p></li>
<li><p>You will be able to profile and optimize various queries to provide the fastest response.</p></li>
</ul>
<p>You already have the data we will use in this lecture from worksheet 2, but if not, please load it so that you can follow with me in lecture (You can load this data to your database using this <a class="reference external" href="https://canvas.ubc.ca/files/24584464/download?download_frd=1">dump</a>. It’s a zip file; do make sure you extract it.). I will use the <code class="docutils literal notranslate"><span class="pre">testindex</span></code> table from <code class="docutils literal notranslate"><span class="pre">fakedata</span></code> schema for demonstration.</p>
</section>
<section id="how-do-humans-store-and-search-data">
<h2>How do humans store and search data?<a class="headerlink" href="#how-do-humans-store-and-search-data" title="Permalink to this headline">#</a></h2>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<a class="reference internal image-reference" href="../_images/lookcartoon.png"><img alt="../_images/lookcartoon.png" src="../_images/lookcartoon.png" style="width: 50%;" /></a>
</aside>
<p>Think about how we used to store data before the era of computers? We used to store the data in books. Let’s take this children’s encyclopedia as an example.</p>
<a class="reference internal image-reference" href="../_images/ency.png"><img alt="../_images/ency.png" src="../_images/ency.png" style="width: 90%;" /></a>
<p>.</p>
<p>There are around 300 <code class="docutils literal notranslate"><span class="pre">pages</span></code> in this book, and if a kid wants to know about <code class="docutils literal notranslate"><span class="pre">China</span></code>, they will go from the first <code class="docutils literal notranslate"><span class="pre">page</span></code> until they get to the 48th page`. There might be other places too that talk about china. So the kid wants to go over all the pages to gather all the information about China.</p>
<p>This is how a kid would <code class="docutils literal notranslate"><span class="pre">search</span></code>, but we are grown up and know about indexes in a book. So if you want to read about china, you would go to the <code class="docutils literal notranslate"><span class="pre">index</span></code> of this book, look for <code class="docutils literal notranslate"><span class="pre">China</span></code>, and go to the 48th page straight away (and to other pages listed in the index). If you want to read some history about indexes, check out <a class="reference external" href="http://www.elephant.org.il/indexing/a-history-of-index-creation">this</a> article.</p>
<p>OKAY, now you all know how humans search for data from a book; Postgres also store and search data similarly.</p>
</section>
<section id="how-does-postgres-store-data">
<h2>How does Postgres store data?<a class="headerlink" href="#how-does-postgres-store-data" title="Permalink to this headline">#</a></h2>
<p>Information within a database is also stored in pages. A database page is not structured like in a book, but it’s structured like below.</p>
<a class="reference internal image-reference" href="../_images/page.png"><img alt="../_images/page.png" src="../_images/page.png" style="width: 90%;" /></a>
<p>.</p>
<p>So these pages are of 8 kB blocks; there are some meta-data as headers (green) at the front of it and item ID (yellow) that points to the tuples(rows). This ends with a special section (blue) left empty in ordinary tables, but if we have some indexes set on the tables, it will have some information to facilitate the index access methods.</p>
<p>So a table within a database will have a list of pages where the data is stored, and these individual pages store multiple tuples within that table.</p>
<p>Read more about it <a class="reference external" href="https://www.postgresql.org/docs/current/storage-page-layout.html">here.</a></p>
</section>
<section id="how-does-postgres-search-data">
<h2>How does Postgres search data?<a class="headerlink" href="#how-does-postgres-search-data" title="Permalink to this headline">#</a></h2>
<p>Let’s consider a complicated table.</p>
<a class="reference internal image-reference" href="../_images/table.png"><img alt="../_images/table.png" src="../_images/table.png" style="width: 70%;" /></a>
<p>For explanation, let’s assume that the contents in this table are stored in 3 page files. Here we are interested in finding the rows with the unique name that starts with <code class="docutils literal notranslate"><span class="pre">y</span></code>. A database, just like a kid, needs to search through the 3 pages to find the rows that contain a name that begins with <code class="docutils literal notranslate"><span class="pre">y</span></code>. This is a sequential search, and this is how a database search by default. This process could be slow if we got millions of rows spread across multiple pages, as the computer needs to go through the entire pages to find the names that start with y.</p>
<p>Also, here in this example, let’s assume that Yokamino is on page 2, the database will find this on page 2, but it will still go to page 3 in search of other occurrences of names that start with y. WHY? Because it doesn’t know that there is only a single occurrence of a name that starts with y.</p>
<p>Let’s look at how Postgres search for data using <code class="docutils literal notranslate"><span class="pre">EXPLAIN</span></code>. We will do this on table <code class="docutils literal notranslate"><span class="pre">fakedata.testindex</span></code>,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>

<span class="o">%</span><span class="k">load_ext</span> sql
<span class="o">%</span><span class="k">config</span> SqlMagic.displaylimit = 20
<span class="o">%</span><span class="k">config</span> SqlMagic.autolimit = 30

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;credentials.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">login</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
<span class="n">username</span> <span class="o">=</span> <span class="n">login</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
<span class="n">password</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">login</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>
<span class="n">host</span> <span class="o">=</span> <span class="n">login</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span>
<span class="n">port</span> <span class="o">=</span> <span class="n">login</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">import</span> <span class="nn">psycopg2</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="kn">import</span> <span class="nn">json</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;matplotlib&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">sql</span> postgresql://{username}:{password}@{host}:{port}/postgres
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Connected: postgres@postgres&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">DROP</span> <span class="n">INDEX</span> <span class="k">if</span> <span class="n">exists</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">hash_testindex_index</span><span class="p">;</span>
<span class="n">DROP</span> <span class="n">INDEX</span> <span class="k">if</span> <span class="n">exists</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">pgweb_idx</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
Done.
Done.
Done.
CPU times: user 9.12 ms, sys: 3.66 ms, total: 12.8 ms
Wall time: 374 ms
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>Here, we do a normal search for a product name within the column <code class="docutils literal notranslate"><span class="pre">productname</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>
<span class="n">explain</span> <span class="n">analyze</span> <span class="n">select</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">fakedata.testindex</span> <span class="n">where</span> <span class="n">productname</span> <span class="o">=</span> <span class="s1">&#39;flavor halibut&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
10 rows affected.
CPU times: user 5.2 ms, sys: 2.02 ms, total: 7.22 ms
Wall time: 1.12 s
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Finalize Aggregate  (cost=144310.50..144310.51 rows=1 width=8) (actual time=1053.246..1054.879 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Gather  (cost=144310.28..144310.49 rows=2 width=8) (actual time=1053.237..1054.873 rows=3 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Planned: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Launched: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Partial Aggregate  (cost=143310.28..143310.29 rows=1 width=8) (actual time=1047.114..1047.115 rows=1 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Parallel Seq Scan on testindex  (cost=0.00..143310.22 rows=24 width=0) (actual time=1047.111..1047.111 rows=0 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter: (productname = &#x27;flavor halibut&#x27;::text)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rows Removed by Filter: 3724110</td>
        </tr>
        <tr>
            <td>Planning Time: 0.241 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 1054.937 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>We are doing a pattern matching search to return all the <code class="docutils literal notranslate"><span class="pre">productname</span></code> that start with <code class="docutils literal notranslate"><span class="pre">fla</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>
<span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> <span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> <span class="n">WHERE</span> <span class="n">productname</span> <span class="n">LIKE</span> <span class="s1">&#39;fla%&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
10 rows affected.
CPU times: user 5.31 ms, sys: 2.06 ms, total: 7.37 ms
Wall time: 1.22 s
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Finalize Aggregate  (cost=144427.95..144427.96 rows=1 width=8) (actual time=1107.191..1108.705 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Gather  (cost=144427.74..144427.95 rows=2 width=8) (actual time=1106.793..1108.696 rows=3 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Planned: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Launched: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Partial Aggregate  (cost=143427.74..143427.75 rows=1 width=8) (actual time=1097.375..1097.376 rows=1 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Parallel Seq Scan on testindex  (cost=0.00..143310.22 rows=47006 width=0) (actual time=0.104..1095.977 rows=9271 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter: (productname ~~ &#x27;fla%&#x27;::text)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rows Removed by Filter: 3714839</td>
        </tr>
        <tr>
            <td>Planning Time: 0.061 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 1108.734 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A query is turned into an internal execution plan breaking the query into specific elements that are re-ordered and optimized. Read more about EXPLAIN <a class="reference external" href="https://www.postgresql.org/docs/9.5/using-explain.html">here</a>. <a class="reference external" href="https://thoughtbot.com/blog/reading-an-explain-analyze-query-plan">This</a> blog also explains it well.</p>
</div>
<p>These are computers, so it’s faster than humans to go through all the pages, but it’s inefficient. <em><strong><em>Won’t it be cool to tell the database that the data you are looking for is only on certain pages, so database don’t want to go through all these pages !!!</em></strong></em> This is WHY we want indexes. We will see if indexing can speed up the previous query.</p>
</section>
<section id="what-are-indexes">
<h2>WHAT are indexes?<a class="headerlink" href="#what-are-indexes" title="Permalink to this headline">#</a></h2>
<p>Indexes make a map of each of these rows effectively as where they are put into the page files so we can do a sequential scan of an index to find the pointer to page/pages this information is stored. So the database can go straight to those pages and skip the rest of the pages.</p>
<a class="reference internal image-reference" href="../_images/indexscan.png"><img alt="../_images/indexscan.png" src="../_images/indexscan.png" style="width: 60%;" /></a>
<p>Index gets applied to a column in a table. As we were querying on the column <code class="docutils literal notranslate"><span class="pre">productname</span></code>, let’s now apply an index to the column <code class="docutils literal notranslate"><span class="pre">productname</span></code> in the database and see how the query execution plan changes. Will it improve the speed? Let’s see..</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>
<span class="n">CREATE</span> <span class="n">INDEX</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span> <span class="n">default_testindex_index</span> <span class="n">ON</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> <span class="p">(</span><span class="n">productname</span> <span class="n">varchar_pattern_ops</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
Done.
CPU times: user 5.91 ms, sys: 3.18 ms, total: 9.09 ms
Wall time: 11 s
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>
<span class="n">explain</span> <span class="n">analyze</span> <span class="n">select</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">fakedata.testindex</span> <span class="n">where</span> <span class="n">productname</span> <span class="o">=</span> <span class="s1">&#39;flavor halibut&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
6 rows affected.
CPU times: user 2.92 ms, sys: 1.48 ms, total: 4.41 ms
Wall time: 59.3 ms
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Aggregate  (cost=5.59..5.60 rows=1 width=8) (actual time=0.032..0.033 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Index Only Scan using default_testindex_index on testindex  (cost=0.43..5.45 rows=58 width=0) (actual time=0.028..0.029 rows=0 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Index Cond: (productname = &#x27;flavor halibut&#x27;::text)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Heap Fetches: 0</td>
        </tr>
        <tr>
            <td>Planning Time: 0.147 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 0.053 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>
<span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> 
<span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> 
<span class="n">WHERE</span> <span class="n">productname</span> <span class="n">LIKE</span> <span class="s1">&#39;fla%&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
7 rows affected.
CPU times: user 4.13 ms, sys: 2.1 ms, total: 6.23 ms
Wall time: 62.8 ms
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Aggregate  (cost=3190.52..3190.53 rows=1 width=8) (actual time=4.434..4.435 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Index Only Scan using default_testindex_index on testindex  (cost=0.43..2908.49 rows=112814 width=0) (actual time=0.042..3.161 rows=27814 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Index Cond: ((productname ~&gt;=~ &#x27;fla&#x27;::text) AND (productname ~&lt;~ &#x27;flb&#x27;::text))</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter: (productname ~~ &#x27;fla%&#x27;::text)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Heap Fetches: 0</td>
        </tr>
        <tr>
            <td>Planning Time: 0.176 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 4.472 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p><em><strong><em>Hurrayyy!!!!</em></strong></em> It increased the speed, and you see that your query planner used the index to speed up queries.</p>
<p>But keep in mind if the selection criteria are too broad, or the INDEX is too imprecise, the query planner will skip it.</p>
<a class="reference internal image-reference" href="../_images/indexscanbroad.png"><img alt="../_images/indexscanbroad.png" src="../_images/indexscanbroad.png" style="width: 65%;" /></a>
<p>Let’s try that out.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> 
<span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> 
<span class="n">WHERE</span> <span class="n">productname</span> <span class="n">LIKE</span> <span class="s1">&#39;%&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
9 rows affected.
CPU times: user 5.53 ms, sys: 2.05 ms, total: 7.58 ms
Wall time: 1.92 s
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Finalize Aggregate  (cost=155947.12..155947.13 rows=1 width=8) (actual time=1833.365..1835.015 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Gather  (cost=155946.90..155947.11 rows=2 width=8) (actual time=1833.090..1835.006 rows=3 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Planned: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Launched: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Partial Aggregate  (cost=154946.90..154946.91 rows=1 width=8) (actual time=1826.680..1826.681 rows=1 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Parallel Seq Scan on testindex  (cost=0.00..143310.22 rows=4654672 width=0) (actual time=0.038..1363.602 rows=3724110 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter: (productname ~~ &#x27;%&#x27;::text)</td>
        </tr>
        <tr>
            <td>Planning Time: 0.066 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 1835.046 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>It’s good that database engines are smart enough to identify if it’s better to look at an index or perform a sequential scan. Here in this example, the database engine understands the query is too broad. But, ultimately, it’s going to search through entire rows, so it’s better to perform a sequential scan rather than look up at the index.</p>
<p>As the index is making a map in the disk, it takes up disk storage. Let’s see how much space this index is taking up</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>
<span class="n">SELECT</span> <span class="n">pg_size_pretty</span> <span class="p">(</span><span class="n">pg_indexes_size</span><span class="p">(</span><span class="s1">&#39;fakedata.testindex&#39;</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
1 rows affected.
CPU times: user 3.49 ms, sys: 1.62 ms, total: 5.11 ms
Wall time: 59.6 ms
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>pg_size_pretty</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>83 MB</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>Now we realize indexes are great! So let’s try some different queries.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> 
<span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> 
<span class="n">WHERE</span> <span class="n">productname</span> <span class="n">LIKE</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">la%&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
10 rows affected.
CPU times: user 4.63 ms, sys: 1.72 ms, total: 6.34 ms
Wall time: 1.46 s
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Finalize Aggregate  (cost=144427.95..144427.96 rows=1 width=8) (actual time=1304.475..1306.018 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Gather  (cost=144427.74..144427.95 rows=2 width=8) (actual time=1304.465..1306.011 rows=3 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Planned: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Launched: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Partial Aggregate  (cost=143427.74..143427.75 rows=1 width=8) (actual time=1297.557..1297.558 rows=1 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Parallel Seq Scan on testindex  (cost=0.00..143310.22 rows=47006 width=0) (actual time=0.068..1294.714 rows=22257 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter: (productname ~~ &#x27;%fla%&#x27;::text)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rows Removed by Filter: 3701853</td>
        </tr>
        <tr>
            <td>Planning Time: 0.094 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 1306.055 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>This was not too broad search; we were trying to return all the elements that contains <code class="docutils literal notranslate"><span class="pre">fla</span></code>. <em><strong><em>But why didn’t it speed things up? So we can’t always go with default indexing, and it might not be helpful in all cases.</em></strong></em> That’s why it’s important to know about different indexes and a general understanding of how it works. This will help you to choose indexes properly in various situations.</p>
</section>
<section id="different-kinds-of-indexes">
<h2>Different kinds of indexes<a class="headerlink" href="#different-kinds-of-indexes" title="Permalink to this headline">#</a></h2>
<p>In this section, we will go through various kinds of indexes and syntax for creating them;</p>
<ul class="simple">
<li><p>B-Tree (binary search tree - btree)</p></li>
<li><p>Hash</p></li>
<li><p>GIST (Generalized Search Tree)</p></li>
<li><p>GIN (Generalized Inverted Tree)</p></li>
<li><p>BRIN (Block Range Index)</p></li>
</ul>
<p>Each has its own set of operations, tied to Postgres functions/operators. For example, you can read about indexes <a class="reference external" href="https://www.postgresql.org/docs/current/indexes-types.html">here</a>.</p>
<p>The general syntax for making an index:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">INDEX</span> <span class="n">indexname</span> <span class="n">ON</span> <span class="n">schema</span><span class="o">.</span><span class="n">tablename</span> <span class="n">USING</span> <span class="n">method</span> <span class="p">(</span><span class="n">columnname</span> <span class="n">opclass</span><span class="p">);</span>
</pre></div>
</div>
<section id="b-tree">
<h3>B-Tree<a class="headerlink" href="#b-tree" title="Permalink to this headline">#</a></h3>
<p>B-Tree is the default index, and you can see we used this previously for column <code class="docutils literal notranslate"><span class="pre">productname</span></code>.</p>
<p>General Syntax: Here the <code class="docutils literal notranslate"> <span class="pre">Operator_Classes</span></code> is optional. Read more on it <a class="reference external" href="https://www.postgresql.org/docs/current/indexes-opclass.html">here</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">INDEX</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span> <span class="n">index_name</span> <span class="n">ON</span> <span class="n">schema</span><span class="o">.</span><span class="n">tablename</span> <span class="p">(</span><span class="n">columnname</span> <span class="n">Operator_Classes</span><span class="p">);</span>
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">INDEX</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span> <span class="n">default_testindex_index</span> <span class="n">ON</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> <span class="p">(</span><span class="n">productname</span> <span class="n">varchar_pattern_ops</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are using B-Tree indexing on a numeric column that you don’t want to specify ‘Operator_Classes’. Operator class <code class="docutils literal notranslate"><span class="pre">varchar_pattern_ops</span></code> is used for character column.</p>
</div>
<p>You will do it on a numeric column in worksheet 3.</p>
<ul class="simple">
<li><p>Values are balanced across nodes to produce a minimum-spanning tree.</p></li>
<li><p>Each node splits values, each “leaf” points to addresses.</p></li>
<li><p>All nodes are equidistant from the root.</p></li>
<li><p>High Key</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/btreenum.png"><img alt="../_images/btreenum.png" src="../_images/btreenum.png" style="width: 80%;" /></a>
<p>Btree is not just about dealing with numbers but also handling text columns; that’s the reason why I gave <code class="docutils literal notranslate"><span class="pre">varchar_pattern_ops</span></code> as <code class="docutils literal notranslate"><span class="pre">opclass</span></code>. So in this example, finds the field that we are looking for in just 3 steps, rather than scanning 7 rows.</p>
<a class="reference internal image-reference" href="../_images/btreealph.png"><img alt="../_images/btreealph.png" src="../_images/btreealph.png" style="width: 80%;" /></a>
</section>
<section id="hash">
<h3>Hash<a class="headerlink" href="#hash" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Cell values are hashed (encoded) form and mapped to address “buckets”</p></li>
<li><p>Hash -&gt; bucket mappings -&gt; disk address</p></li>
<li><p>The hash function tries to balance the number of buckets &amp; number of addresses within a bucket</p></li>
<li><p>Hash only supports EQUALITY</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/hash.png"><img alt="../_images/hash.png" src="../_images/hash.png" style="width: 80%;" /></a>
<p>Let’s create a hash index on column <code class="docutils literal notranslate"><span class="pre">productname</span></code> and execute queries that we ran before</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">DROP</span> <span class="n">INDEX</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">default_testindex_index</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">INDEX</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span> <span class="n">hash_testindex_index</span> <span class="n">ON</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> <span class="n">USING</span> <span class="nb">hash</span><span class="p">(</span><span class="n">productname</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
Done.
Done.
CPU times: user 7.3 ms, sys: 3.7 ms, total: 11 ms
Wall time: 15.9 s
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>
<span class="n">explain</span> <span class="n">analyze</span> <span class="n">select</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">fakedata.testindex</span> <span class="n">where</span> <span class="n">productname</span> <span class="o">=</span> <span class="s1">&#39;flavor halibut&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
7 rows affected.
CPU times: user 4.02 ms, sys: 1.89 ms, total: 5.92 ms
Wall time: 65.3 ms
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Aggregate  (cost=232.78..232.79 rows=1 width=8) (actual time=0.017..0.018 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Bitmap Heap Scan on testindex  (cost=4.45..232.63 rows=58 width=0) (actual time=0.013..0.013 rows=0 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Recheck Cond: (productname = &#x27;flavor halibut&#x27;::text)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Bitmap Index Scan on hash_testindex_index  (cost=0.00..4.43 rows=58 width=0) (actual time=0.011..0.011 rows=0 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Index Cond: (productname = &#x27;flavor halibut&#x27;::text)</td>
        </tr>
        <tr>
            <td>Planning Time: 0.147 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 0.051 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>
<span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> 
<span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> 
<span class="n">WHERE</span> <span class="n">productname</span> <span class="n">LIKE</span> <span class="s1">&#39;fla%&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
10 rows affected.
CPU times: user 5.77 ms, sys: 2.51 ms, total: 8.28 ms
Wall time: 1.49 s
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Finalize Aggregate  (cost=144427.95..144427.96 rows=1 width=8) (actual time=1423.753..1425.522 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Gather  (cost=144427.74..144427.95 rows=2 width=8) (actual time=1423.743..1425.516 rows=3 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Planned: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Launched: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Partial Aggregate  (cost=143427.74..143427.75 rows=1 width=8) (actual time=1413.177..1413.178 rows=1 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Parallel Seq Scan on testindex  (cost=0.00..143310.22 rows=47006 width=0) (actual time=0.135..1409.815 rows=9271 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter: (productname ~~ &#x27;fla%&#x27;::text)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rows Removed by Filter: 3714839</td>
        </tr>
        <tr>
            <td>Planning Time: 0.084 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 1425.552 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>
<span class="n">SELECT</span> <span class="n">pg_size_pretty</span> <span class="p">(</span><span class="n">pg_indexes_size</span><span class="p">(</span><span class="s1">&#39;fakedata.testindex&#39;</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
1 rows affected.
CPU times: user 4.06 ms, sys: 1.69 ms, total: 5.76 ms
Wall time: 67.8 ms
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>pg_size_pretty</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>381 MB</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<ul class="simple">
<li><p>Why do you think hash takes up more space here?</p></li>
<li><p>When do you think it’s best to you hash indexing?</p></li>
</ul>
</section>
<section id="gin">
<h3>GIN<a class="headerlink" href="#gin" title="Permalink to this headline">#</a></h3>
<p>Before talking about GIN indexes, let me give you a little bit of background on a full-text search. Full-text search is usually used if you have a column with sentences and you need to query rows based on the match for a particular string in that sentence. For example, say we want to get rows with <code class="docutils literal notranslate"><span class="pre">new</span></code> in the <code class="docutils literal notranslate"><span class="pre">sentence</span></code> column.</p>
<table class="colwidths-auto table">
<thead>
<tr class="row-odd"><th class="head"><p>row number</p></th>
<th class="head"><p>sentence</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>this column has to do some thing with new year, also has to do something with row</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>this column has to do some thing with colors</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>new year celebrated on 1st Jan</p></td>
</tr>
<tr class="row-odd"><td><p>4</p></td>
<td><p>new year celebration was very great this year</p></td>
</tr>
<tr class="row-even"><td><p>5</p></td>
<td><p>This is about cars released this year</p></td>
</tr>
</tbody>
</table>
<p>We usually query it this way, this definitely will return our result, but it takes time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> 
<span class="n">WHERE</span> <span class="n">productname</span> <span class="n">LIKE</span> <span class="s1">&#39;%new%&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
27510 rows affected.
CPU times: user 24.6 ms, sys: 22.1 ms, total: 46.7 ms
Wall time: 1.66 s
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>nameid</th>
            <th>productid</th>
            <th>productname</th>
            <th>price</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>60</td>
            <td>325578</td>
            <td>replace news</td>
            <td>$41.82</td>
        </tr>
        <tr>
            <td>171</td>
            <td>34359</td>
            <td>newsstand bird</td>
            <td>$26.18</td>
        </tr>
        <tr>
            <td>183</td>
            <td>24364</td>
            <td>newsstand Charles</td>
            <td>$76.91</td>
        </tr>
        <tr>
            <td>201</td>
            <td>142804</td>
            <td>Venezuela news</td>
            <td>$8.37</td>
        </tr>
        <tr>
            <td>285</td>
            <td>90194</td>
            <td>news cub</td>
            <td>$31.87</td>
        </tr>
        <tr>
            <td>392</td>
            <td>185778</td>
            <td>ounce newsstand</td>
            <td>$92.40</td>
        </tr>
        <tr>
            <td>496</td>
            <td>158475</td>
            <td>newsprint softball</td>
            <td>$81.24</td>
        </tr>
        <tr>
            <td>582</td>
            <td>83529</td>
            <td>hub newsstand</td>
            <td>$87.06</td>
        </tr>
        <tr>
            <td>644</td>
            <td>130920</td>
            <td>news carbon</td>
            <td>$44.99</td>
        </tr>
        <tr>
            <td>691</td>
            <td>158475</td>
            <td>newsprint softball</td>
            <td>$81.24</td>
        </tr>
        <tr>
            <td>760</td>
            <td>221233</td>
            <td>news frog</td>
            <td>$64.35</td>
        </tr>
        <tr>
            <td>783</td>
            <td>199957</td>
            <td>cathedral newsstand</td>
            <td>$23.38</td>
        </tr>
        <tr>
            <td>798</td>
            <td>92081</td>
            <td>cod newsstand</td>
            <td>$87.92</td>
        </tr>
        <tr>
            <td>858</td>
            <td>250217</td>
            <td>result newsstand</td>
            <td>$50.36</td>
        </tr>
        <tr>
            <td>1002</td>
            <td>204775</td>
            <td>sing newsstand</td>
            <td>$57.54</td>
        </tr>
        <tr>
            <td>1025</td>
            <td>83529</td>
            <td>hub newsstand</td>
            <td>$87.06</td>
        </tr>
        <tr>
            <td>1262</td>
            <td>166133</td>
            <td>chauffeur newsprint</td>
            <td>$77.66</td>
        </tr>
        <tr>
            <td>1324</td>
            <td>24364</td>
            <td>newsstand Charles</td>
            <td>$76.91</td>
        </tr>
        <tr>
            <td>1410</td>
            <td>51369</td>
            <td>lynx newsstand</td>
            <td>$0.85</td>
        </tr>
        <tr>
            <td>1490</td>
            <td>158475</td>
            <td>newsprint softball</td>
            <td>$81.24</td>
        </tr>
    </tbody>
</table>
<span style="font-style:italic;text-align:center;">30 rows, truncated to displaylimit of 20</span></div></div>
</div>
<p>That’s why we go for full-text search; I found <a class="reference external" href="https://arctype.com/blog/postgres-full-text-search/">this</a> blog to help understand this.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="o">*</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> 
<span class="n">WHERE</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span> <span class="n">sentence</span><span class="p">)</span> <span class="o">@@</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="s1">&#39;new&#39;</span><span class="p">);</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>Here we are converting the type of column <code class="docutils literal notranslate"><span class="pre">sentence</span></code> to <code class="docutils literal notranslate"><span class="pre">tsvector</span></code>
Here the first row in sentence column <code class="docutils literal notranslate"><span class="pre">this</span> <span class="pre">column</span> <span class="pre">has</span> <span class="pre">to</span> <span class="pre">do</span> <span class="pre">something</span> <span class="pre">with</span> <span class="pre">the</span> <span class="pre">new</span> <span class="pre">year,</span> <span class="pre">also</span> <span class="pre">has</span> <span class="pre">to</span> <span class="pre">do</span> <span class="pre">something</span> <span class="pre">with</span> <span class="pre">row</span></code> will be represented like this internally</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;also&#39;</span><span class="p">:</span><span class="mi">11</span> <span class="s1">&#39;column&#39;</span><span class="p">:</span><span class="mi">2</span> <span class="s1">&#39;do&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="mi">14</span> <span class="s1">&#39;has&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">12</span> <span class="s1">&#39;new&#39;</span><span class="p">:</span><span class="mi">9</span> <span class="s1">&#39;row&#39;</span><span class="p">:</span><span class="mi">17</span> <span class="s1">&#39;some&#39;</span><span class="p">:</span><span class="mi">6</span> <span class="s1">&#39;something&#39;</span><span class="p">:</span><span class="mi">15</span> <span class="s1">&#39;thing&#39;</span><span class="p">:</span><span class="mi">7</span> <span class="s1">&#39;this&#39;</span><span class="p">:</span><span class="mi">1</span> <span class="s1">&#39;to&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">13</span> <span class="s1">&#39;with&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="mi">16</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span><span class="mi">10</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">to_tsquery</span></code> is how you query, and here we query for <code class="docutils literal notranslate"><span class="pre">new</span></code> using <code class="docutils literal notranslate"><span class="pre">to_tsquery('english','new')</span></code>.</p>
<p>Postgres does a pretty good job with the full-text search, but if we want to speed up the search, we go for GIN indexes. The column needs to be of <code class="docutils literal notranslate"><span class="pre">tsvector</span></code> type for a full-text search.</p>
<ul class="simple">
<li><p>Indexing many values to the same row</p></li>
<li><p>Inverse of B-tree - one value to many rows
e.g., “quick”, or “brown” or “the” all point to row 1</p></li>
<li><p>Most commonly used for <code class="docutils literal notranslate"><span class="pre">full-text</span> <span class="pre">searching.</span></code></p></li>
</ul>
<a class="reference internal image-reference" href="../_images/gin.png"><img alt="../_images/gin.png" src="../_images/gin.png" style="width: 50%;" /></a>
<p>Let’s try these on our tables; Following is how much time it will take without indexing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> <span class="n">SELECT</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> <span class="n">WHERE</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span> <span class="n">productname</span><span class="p">)</span> <span class="o">@@</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="s1">&#39;flavor&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
10 rows affected.
CPU times: user 8.15 ms, sys: 3.02 ms, total: 11.2 ms
Wall time: 26.1 s
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Finalize Aggregate  (cost=1308153.11..1308153.12 rows=1 width=8) (actual time=25990.828..25990.914 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Gather  (cost=1308152.89..1308153.10 rows=2 width=8) (actual time=25988.713..25990.905 rows=3 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Planned: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Launched: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Partial Aggregate  (cost=1307152.89..1307152.90 rows=1 width=8) (actual time=25982.643..25982.644 rows=1 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Parallel Seq Scan on testindex  (cost=0.00..1307094.70 rows=23276 width=0) (actual time=6.548..25978.503 rows=3158 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter: (to_tsvector(&#x27;english&#x27;::regconfig, productname) @@ &#x27;&#x27;&#x27;flavor&#x27;&#x27;&#x27;::tsquery)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rows Removed by Filter: 3720952</td>
        </tr>
        <tr>
            <td>Planning Time: 0.825 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 25990.944 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>Let’s see how much time it is going to take with indexing. Before that we want to create index for the column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">DROP</span> <span class="n">INDEX</span> <span class="k">if</span> <span class="n">exists</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">hash_testindex_index</span><span class="p">;</span>
<span class="n">DROP</span> <span class="n">INDEX</span> <span class="k">if</span> <span class="n">exists</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">pgweb_idx</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">INDEX</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span> <span class="n">pgweb_idx</span> <span class="n">ON</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> <span class="n">USING</span> <span class="n">GIN</span> <span class="p">(</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span> <span class="n">productname</span><span class="p">));</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
Done.
Done.
Done.
CPU times: user 13.9 ms, sys: 5.37 ms, total: 19.3 ms
Wall time: 40.4 s
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>Here is how much time it is taking with indexing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> <span class="n">SELECT</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> <span class="n">WHERE</span> <span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span> <span class="n">productname</span><span class="p">)</span> <span class="o">@@</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="s1">&#39;flavor&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
12 rows affected.
CPU times: user 4.02 ms, sys: 1.69 ms, total: 5.71 ms
Wall time: 75.2 ms
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Finalize Aggregate  (cost=87233.51..87233.52 rows=1 width=8) (actual time=14.016..15.186 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Gather  (cost=87233.30..87233.51 rows=2 width=8) (actual time=8.623..15.177 rows=3 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Planned: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Launched: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Partial Aggregate  (cost=86233.30..86233.31 rows=1 width=8) (actual time=3.877..3.878 rows=1 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Parallel Bitmap Heap Scan on testindex  (cost=520.93..86175.11 rows=23276 width=0) (actual time=2.003..3.605 rows=3158 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Recheck Cond: (to_tsvector(&#x27;english&#x27;::regconfig, productname) @@ &#x27;&#x27;&#x27;flavor&#x27;&#x27;&#x27;::tsquery)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Heap Blocks: exact=4537</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Bitmap Index Scan on pgweb_idx  (cost=0.00..506.96 rows=55862 width=0) (actual time=3.680..3.680 rows=9474 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Index Cond: (to_tsvector(&#x27;english&#x27;::regconfig, productname) @@ &#x27;&#x27;&#x27;flavor&#x27;&#x27;&#x27;::tsquery)</td>
        </tr>
        <tr>
            <td>Planning Time: 0.184 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 15.224 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p><em>Wooohoooo!!! A great improvement!!</em> By creating a materialized view (We will see more about views in next class) with a computed <code class="docutils literal notranslate"><span class="pre">tsvector</span></code> column, we can make searches even faster, since it will not be necessary to redo the <code class="docutils literal notranslate"><span class="pre">to_tsvector</span></code> calls to verify index matches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>
<span class="n">CREATE</span> <span class="n">MATERIALIZED</span> <span class="n">VIEW</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex_materialized</span> <span class="k">as</span> <span class="n">select</span> <span class="o">*</span><span class="p">,</span><span class="n">to_tsvector</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span> <span class="n">productname</span><span class="p">)</span> <span class="k">as</span> <span class="n">productname_ts</span> 
<span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">INDEX</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span> <span class="n">pgweb_idx_mat</span> <span class="n">ON</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex_materialized</span> <span class="n">USING</span> <span class="n">GIN</span> <span class="p">(</span><span class="n">productname_ts</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
Done.
Done.
CPU times: user 6.89 ms, sys: 2.93 ms, total: 9.82 ms
Wall time: 250 ms
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> <span class="n">SELECT</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex_materialized</span> <span class="n">WHERE</span> <span class="n">productname_ts</span> <span class="o">@@</span> <span class="n">to_tsquery</span><span class="p">(</span><span class="s1">&#39;english&#39;</span><span class="p">,</span><span class="s1">&#39;flavor&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
8 rows affected.
CPU times: user 4.53 ms, sys: 2.27 ms, total: 6.8 ms
Wall time: 65 ms
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Aggregate  (cost=31354.41..31354.42 rows=1 width=8) (actual time=5.317..5.318 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Bitmap Heap Scan on testindex_materialized  (cost=101.93..31329.27 rows=10055 width=0) (actual time=3.109..4.841 rows=9474 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Recheck Cond: (productname_ts @@ &#x27;&#x27;&#x27;flavor&#x27;&#x27;&#x27;::tsquery)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Heap Blocks: exact=9144</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Bitmap Index Scan on pgweb_idx_mat  (cost=0.00..99.42 rows=10055 width=0) (actual time=1.626..1.626 rows=9474 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Index Cond: (productname_ts @@ &#x27;&#x27;&#x27;flavor&#x27;&#x27;&#x27;::tsquery)</td>
        </tr>
        <tr>
            <td>Planning Time: 0.419 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 5.353 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>This indexing does speed up things if we want to search for a particular word from a column, like <code class="docutils literal notranslate"><span class="pre">flavor</span></code>. But if we want to search for some pattern within a sentence, then this index won’t help. EG the query what we trying from beginning</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> 
<span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> 
<span class="n">WHERE</span> <span class="n">productname</span> <span class="n">LIKE</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">la%&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
10 rows affected.
CPU times: user 6.14 ms, sys: 2.7 ms, total: 8.83 ms
Wall time: 1.58 s
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Finalize Aggregate  (cost=144427.95..144427.96 rows=1 width=8) (actual time=1433.263..1434.450 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Gather  (cost=144427.74..144427.95 rows=2 width=8) (actual time=1433.254..1434.444 rows=3 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Planned: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Launched: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Partial Aggregate  (cost=143427.74..143427.75 rows=1 width=8) (actual time=1421.513..1421.514 rows=1 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Parallel Seq Scan on testindex  (cost=0.00..143310.22 rows=47006 width=0) (actual time=0.094..1417.011 rows=22257 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter: (productname ~~ &#x27;%fla%&#x27;::text)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rows Removed by Filter: 3701853</td>
        </tr>
        <tr>
            <td>Planning Time: 0.065 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 1434.482 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>Hence, we want a different flavor of gin indexing, trigram index. I found <a class="reference external" href="https://scoutapm.com/blog/how-to-make-text-searches-in-postgresql-faster-with-trigram-similarity">this</a> blog to help understand this.</p>
<section id="trigrams-details-optional">
<h4>Trigrams Details (OPTIONAL)<a class="headerlink" href="#trigrams-details-optional" title="Permalink to this headline">#</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Trigrams</span></code> are a special case of <a class="reference external" href="https://web.stanford.edu/~jurafsky/slp3/4.pdf">N-grams</a>. The concept relies on dividing the sentence into a sequence of three consecutive letters, and this result is considered as a <code class="docutils literal notranslate"><span class="pre">set</span></code>. Before performing this process</p>
<ul class="simple">
<li><p>Two blank spaces are added at the beginning.</p></li>
<li><p>One at the end.</p></li>
<li><p>Double ones replace single spaces.</p></li>
</ul>
<p>The trigram set corresponding to “flavor halibut” looks like this:</p>
<p>{”  f”,”  h”,” fl”,” ha”,ali,avo,but,fla,hal,ibu,lav,lib,”or “,”ut “,vor}</p>
<p>These are considered words, and the rest remains the same as what we discussed before. To use this index add <code class="docutils literal notranslate"><span class="pre">gin_trgm_ops</span></code> as <code class="docutils literal notranslate"><span class="pre">operator</span> <span class="pre">class</span></code>. Let’s do it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>
<span class="n">CREATE</span> <span class="n">EXTENSION</span> <span class="n">pg_trgm</span><span class="p">;</span>
<span class="n">DROP</span> <span class="n">INDEX</span> <span class="k">if</span> <span class="n">exists</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">pgweb_idx</span><span class="p">;</span>
<span class="n">CREATE</span> <span class="n">INDEX</span> <span class="n">pgweb_idx</span> <span class="n">ON</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> <span class="n">USING</span> <span class="n">GIN</span> <span class="p">(</span><span class="n">productname</span> <span class="n">gin_trgm_ops</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
Done.
(psycopg2.errors.UndefinedObject) operator class &quot;gin_trgm_ops&quot; does not exist for access method &quot;gin&quot;

[SQL: CREATE INDEX pgweb_idx ON fakedata.testindex USING GIN (productname gin_trgm_ops);]
(Background on this error at: https://sqlalche.me/e/14/f405)
CPU times: user 4.53 ms, sys: 1.94 ms, total: 6.46 ms
Wall time: 195 ms
</pre></div>
</div>
</div>
</div>
<p>Let’s see if it speeds up the query that we tried in many cases before.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> 
<span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> 
<span class="n">WHERE</span> <span class="n">productname</span> <span class="n">LIKE</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">la%&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
10 rows affected.
CPU times: user 4.69 ms, sys: 2.06 ms, total: 6.76 ms
Wall time: 1.74 s
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Finalize Aggregate  (cost=144427.95..144427.96 rows=1 width=8) (actual time=1583.628..1585.183 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Gather  (cost=144427.74..144427.95 rows=2 width=8) (actual time=1583.619..1585.176 rows=3 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Planned: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Launched: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Partial Aggregate  (cost=143427.74..143427.75 rows=1 width=8) (actual time=1576.930..1576.931 rows=1 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Parallel Seq Scan on testindex  (cost=0.00..143310.22 rows=47006 width=0) (actual time=0.045..1570.940 rows=22257 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter: (productname ~~ &#x27;%fla%&#x27;::text)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rows Removed by Filter: 3701853</td>
        </tr>
        <tr>
            <td>Planning Time: 0.104 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 1585.214 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="o">%%</span><span class="n">sql</span>

<span class="n">EXPLAIN</span> <span class="n">ANALYZE</span> 
<span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">fakedata</span><span class="o">.</span><span class="n">testindex</span> 
<span class="n">WHERE</span> <span class="n">productname</span> <span class="n">LIKE</span> <span class="s1">&#39;</span><span class="si">%f</span><span class="s1">lavor%&#39;</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> * postgresql://postgres:***@mbandtweet.cpcoibvq7lck.us-west-2.rds.amazonaws.com:5432/postgres
10 rows affected.
CPU times: user 5.88 ms, sys: 2.12 ms, total: 8 ms
Wall time: 1.42 s
</pre></div>
</div>
<div class="output text_html"><table>
    <thead>
        <tr>
            <th>QUERY PLAN</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Finalize Aggregate  (cost=144311.60..144311.61 rows=1 width=8) (actual time=1297.564..1299.146 rows=1 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;-&gt;  Gather  (cost=144311.39..144311.60 rows=2 width=8) (actual time=1297.555..1299.139 rows=3 loops=1)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Planned: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Workers Launched: 2</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Partial Aggregate  (cost=143311.39..143311.40 rows=1 width=8) (actual time=1290.749..1290.750 rows=1 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;  Parallel Seq Scan on testindex  (cost=0.00..143310.22 rows=465 width=0) (actual time=0.127..1290.168 rows=3158 loops=3)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Filter: (productname ~~ &#x27;%flavor%&#x27;::text)</td>
        </tr>
        <tr>
            <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rows Removed by Filter: 3720952</td>
        </tr>
        <tr>
            <td>Planning Time: 0.058 ms</td>
        </tr>
        <tr>
            <td>Execution Time: 1299.178 ms</td>
        </tr>
    </tbody>
</table></div></div>
</div>
<p>Finally, we see this query is using indexes, and it did speed up the query.</p>
</section>
</section>
<section id="gist">
<h3>GIST<a class="headerlink" href="#gist" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Supports many search types, including spatial and full text.</p></li>
<li><p>Can be extended to custom data types</p></li>
<li><p>Balanced tree-based method (nodes &amp; leaves)</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/gist.png"><img alt="../_images/gist.png" src="../_images/gist.png" style="width: 50%;" /></a>
</section>
<section id="brin">
<h3>BRIN<a class="headerlink" href="#brin" title="Permalink to this headline">#</a></h3>
<ul class="simple">
<li><p>Indexes block statistics for ordered data</p></li>
<li><p>Block min &amp; max mapped to index</p></li>
<li><p>Search finds block first, then finds values</p></li>
<li><p>Best for larger volumes of data</p></li>
<li><p>This is essentially how we read a book’s index.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/brin.png"><img alt="../_images/brin.png" src="../_images/brin.png" style="width: 50%;" /></a>
<p>Usage</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CREATE</span> <span class="n">INDEX</span> <span class="n">index_name</span> <span class="n">ON</span> <span class="n">schema</span><span class="o">.</span><span class="n">table</span><span class="o">/</span><span class="n">view</span> <span class="n">USING</span> <span class="n">BRIN</span><span class="p">(</span><span class="n">columnname</span><span class="p">);</span>
</pre></div>
</div>
<p>We will use this later when we go through our Twitter example (tomorrow’s lecture).</p>
<p>Now we have learned about indexes, can you answer these questions?</p>
<ul class="simple">
<li><p>What are indexes?</p></li>
<li><p>Different types of indexes?</p></li>
<li><p>When to use indexes?</p></li>
<li><p>How to use an index?</p></li>
<li><p>Why do I need an index?</p></li>
</ul>
</section>
</section>
<section id="compared-to-other-services-optional">
<h2>Compared to Other Services (optional)<a class="headerlink" href="#compared-to-other-services-optional" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>BigQuery, AWS RedShift</p>
<ul>
<li><p>Don’t use Indexes, infrastructure searches whole “columns”</p></li>
</ul>
</li>
<li><p>MongoDB</p>
<ul>
<li><p>Single &amp; multiparameter indexes (similar to b-tree)</p></li>
<li><p>spatial (similar to GIST)</p></li>
<li><p>text indexes (similar to GIN)</p></li>
<li><p>hash index</p></li>
</ul>
</li>
<li><p>Neo4j (Graph Database)</p>
<ul>
<li><p>b-tree and full text</p></li>
</ul>
</li>
</ul>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p>Indexes are important to speed up operations</p></li>
<li><p>Indexes are optimized to certain kinds of data</p></li>
<li><p>Index performance can be assessed using <code class="docutils literal notranslate"><span class="pre">EXPLAIN.</span></code></p></li>
<li><p>Indexes can come at a cost and should be careful in selecting it.</p></li>
</ul>
</section>
<section id="class-activity">
<h2>Class activity<a class="headerlink" href="#class-activity" title="Permalink to this headline">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Check worksheet 3 in canvas for detailed instructions on activity and submission instructions.</p>
</div>
<ul class="simple">
<li><p>Setting up index</p></li>
<li><p>Experience the performance with/without and with different types of indexes.</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "ggeorg02/BAIT580",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./lectures"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#announcements">Announcements</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#todays-agenda">Todays Agenda</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#learning-objectives">Learning objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-do-humans-store-and-search-data">How do humans store and search data?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-does-postgres-store-data">How does Postgres store data?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#how-does-postgres-search-data">How does Postgres search data?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-are-indexes">WHAT are indexes?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#different-kinds-of-indexes">Different kinds of indexes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#b-tree">B-Tree</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hash">Hash</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gin">GIN</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#trigrams-details-optional">Trigrams Details (OPTIONAL)</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gist">GIST</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#brin">BRIN</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#compared-to-other-services-optional">Compared to Other Services (optional)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#class-activity">Class activity</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Gittu George, PhD
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>